{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h3>📘 강의자료 목록</h3>
  <table class="table table-striped table-bordered text-center align-middle">
    <!-- (중략: 기존 강의자료 테이블 동일) -->
  </table>

  <hr class="my-4">

  <section style="background:#f8f9fa;padding:20px;border-radius:12px;">
    <h4>💬 학생 질문 게시판 
      <small class="text-muted">(비밀번호 4자리 / 교수 비번: 5555)</small>
    </h4>

    <!-- 질문 입력 -->
    <form method="POST" onsubmit="return validateStudentForm();" class="mb-4">
      <input type="hidden" name="action" value="add_qna">
      <div class="d-flex gap-2">
        <input type="text" name="name" class="form-control" placeholder="이름(선택)" style="width:20%;">
        <input type="text" name="question" class="form-control" placeholder="질문을 입력하세요" style="width:55%;" required>
        <input type="password" id="studentPassword" name="password" maxlength="4" class="form-control" placeholder="비밀번호(4자리)" style="width:15%;" required>
        <button type="submit" class="btn btn-primary" style="width:10%;">등록</button>
      </div>
    </form>

    {% for item in qna %}
    <div style="background:white;border:1px solid #ddd;border-radius:10px;padding:15px;margin-bottom:18px;">
      <b>Q. {{ item["질문"] }}</b><br>
      <small class="text-muted">({{ item["이름"] }}, {{ item["등록시각"] }})</small>

      <!-- 학생 삭제 -->
      <form method="POST" class="mt-2 mb-2">
        <input type="hidden" name="action" value="delete_qna">
        <input type="hidden" name="index" value="{{ loop.index0 }}">
        <input type="password" name="password" maxlength="4" placeholder="비밀번호(질문삭제용)" style="width:130px;">
        <button class="btn btn-sm btn-danger">삭제</button>
      </form>

      <hr style="border-top:4px solid #666; margin:14px 0;">

      {% if item["답변"] %}
        <div class="p-2" style="background:#eef6ff;border-left:5px solid #007bff;border-radius:6px;">
          <b style="color:#007bff;">A.</b> {{ item["답변"] }}
          <!-- ✏️ 수정 / 삭제 -->
          <form method="POST" class="d-inline ms-2">
            <input type="hidden" name="action" value="delete_reply">
            <input type="hidden" name="index" value="{{ loop.index0 }}">
            <input type="password" name="password" maxlength="4" placeholder="5555" style="width:80px;">
            <button class="btn btn-sm btn-outline-danger py-0">삭제</button>
          </form>
          <button class="btn btn-sm btn-outline-primary py-0 ms-1" onclick="toggleEdit({{ loop.index0 }})">✏️ 수정</button>
        </div>

        <!-- ✏️ 수정 폼 (숨김) -->
        <form id="editForm{{ loop.index0 }}" method="POST" class="mt-2" style="display:none;">
          <input type="hidden" name="action" value="reply_qna">
          <input type="hidden" name="index" value="{{ loop.index0 }}">
          <textarea name="reply" class="form-control mb-1" required>{{ item["답변"] }}</textarea>
          <input type="password" name="password" maxlength="4" placeholder="교수비번(5555)" style="width:100px;">
          <button class="btn btn-sm btn-success">수정 완료</button>
        </form>
      {% else %}
        <!-- 답변 등록 -->
        <form method="POST" class="mt-3">
          <input type="hidden" name="action" value="reply_qna">
          <input type="hidden" name="index" value="{{ loop.index0 }}">
          <textarea name="reply" placeholder="교수 답변 입력..." class="form-control mb-1" required>{{ temp_reply if wrong_pw_index == loop.index0 else "" }}</textarea>
          <input type="password" name="password" maxlength="4" placeholder="교수비번(5555)" style="width:100px;">
          <button class="btn btn-sm btn-success">답변 등록</button>
        </form>
      {% endif %}
    </div>
    {% endfor %}
  </section>
</div>

<script>
function validateStudentForm() {
  const pw = document.getElementById('studentPassword').value.trim();
  if (!/^\d{4}$/.test(pw)) {
    alert('비밀번호를 다시 입력하세요 (숫자 4자리)');
    return false;
  }
  return true;
}

function toggleEdit(idx) {
  const form = document.getElementById('editForm' + idx);
  form.style.display = (form.style.display === 'none' ? 'block' : 'none');
}
</script>
{% endblock %}
