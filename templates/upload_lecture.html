{% extends "base.html" %}
{% block content %}
<div class="container mt-4">

  <h3 class="mb-4">ğŸ“¤ ê°•ì˜ìë£Œ ì—…ë¡œë“œ</h3>

  <!-- ì—…ë¡œë“œ í¼ -->
  <form action="{{ url_for('upload_lecture') }}" method="post" enctype="multipart/form-data" class="mb-5">
    <div class="mb-3">
      <label class="form-label">ì œëª©</label>
      <input type="text" name="title" class="form-control" required>
    </div>

    <div class="mb-3">
      <label class="form-label">ë‚´ìš©</label>
      <textarea name="content" class="form-control" rows="3" required></textarea>
    </div>

    <!-- íŒŒì¼ ì—…ë¡œë“œ -->
    <div class="mb-3">
      <label class="form-label">íŒŒì¼ ì„ íƒ</label>
      <div id="fileInputs">
        <input type="file" name="files" multiple class="form-control mb-2">
      </div>
      <button type="button" class="btn btn-sm btn-primary" onclick="addFileField()">+ íŒŒì¼ ì¶”ê°€</button>
      <button type="button" class="btn btn-sm btn-danger" onclick="removeFileField()">- íŒŒì¼ ì‚­ì œ</button>
    </div>

    <!-- ë§í¬ ì…ë ¥ -->
    <div class="mb-3">
      <label class="form-label">ğŸ”— ê´€ë ¨ ì‚¬ì´íŠ¸ ë§í¬</label>
      <div id="linkInputs">
        <input type="url" name="link1" placeholder="https://example.com" class="form-control mb-2">
      </div>
      <button type="button" class="btn btn-sm btn-primary" onclick="addLinkField()">+ ë§í¬ ì¶”ê°€</button>
      <button type="button" class="btn btn-sm btn-danger" onclick="removeLinkField()">- ë§í¬ ì‚­ì œ</button>
    </div>

    <button type="submit" class="btn btn-success w-100">ğŸ“¤ ì—…ë¡œë“œ</button>
  </form>

  <!-- ì—…ë¡œë“œëœ ìë£Œ ëª©ë¡ -->
  <h4 class="mt-5">ğŸ“š ì—…ë¡œë“œëœ ìë£Œ</h4>

  {% for lec in lectures %}
  <div class="card my-3 p-3">
    <h5>{{ lec.title or "(ì œëª© ì—†ìŒ)" }}</h5>
    <p>{{ lec.content or "(ë‚´ìš© ì—†ìŒ)" }}</p>

    {% if lec.files %}
    <p>ğŸ“ íŒŒì¼:
      {% for f in lec.files.split(';') %}
        <a href="{{ url_for('uploaded_file', filename=f.strip()) }}" target="_blank">{{ f.strip() }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
    {% endif %}

    {% if lec.links %}
    <p>ğŸ”— ë§í¬:
      {% for l in lec.links.split(';') %}
        <a href="{{ l.strip() }}" target="_blank">{{ l.strip() }}</a>{% if not loop.last %}, {% endif %}
      {% endfor %}
    </p>
    {% endif %}

    <p class="text-muted">ì—…ë¡œë“œì¼: {{ lec.date }}</p>

    {% if is_professor %}
    <form action="{{ url_for('confirm_lecture', index=loop.index0) }}" method="post" class="d-inline">
      <button type="submit" class="btn btn-sm btn-primary">ğŸ“¢ ê²Œì‹œ</button>
    </form>

    <form action="{{ url_for('delete_lecture', index=loop.index0) }}" method="post" class="d-inline">
      <button type="submit" class="btn btn-sm btn-danger">ğŸ—‘ ì‚­ì œ</button>
    </form>

    <!-- ìˆ˜ì • ë²„íŠ¼ -->
    <button class="btn btn-sm btn-warning" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#editForm{{ loop.index0 }}">âœï¸ ìˆ˜ì •</button>

    <!-- ìˆ˜ì • í¼ -->
    <div class="collapse mt-3" id="editForm{{ loop.index0 }}">
      <form action="{{ url_for('edit_lecture', index=loop.index0) }}" method="post" enctype="multipart/form-data">
        <div class="mb-2">
          <input type="text" name="title" value="{{ lec.title }}" class="form-control">
        </div>
        <div class="mb-2">
          <textarea name="content" class="form-control" rows="3">{{ lec.content }}</textarea>
        </div>

        <!-- ê¸°ì¡´ íŒŒì¼ ëª©ë¡ -->
        {% if lec.files %}
        <p class="mt-2">í˜„ì¬ ë“±ë¡ëœ íŒŒì¼</p>
        <div id="currentFiles{{ loop.index0 }}">
          {% for f in lec.files.split(';') %}
          <div class="mb-1">
            <a href="{{ url_for('uploaded_file', filename=f.strip()) }}" target="_blank">{{ f.strip() }}</a>
            <button type="button" class="btn btn-sm btn-outline-danger ms-2"
                    onclick="removeExistingFile({{ loop.index0 }}, '{{ f.strip() }}')">ğŸ—‘</button>
          </div>
          {% endfor %}
        </div>
        {% endif %}
        <input type="hidden" id="deleteFiles{{ loop.index0 }}" name="delete_files" value="">

        <!-- ìƒˆ íŒŒì¼ ì¶”ê°€ -->
        <label class="form-label mt-2">ìƒˆ íŒŒì¼ ì¶”ê°€</label>
        <div class="mb-2">
          <input type="file" name="new_files" multiple class="form-control mb-2">
          <button type="button" class="btn btn-sm btn-primary" onclick="addNewFileField()">+ íŒŒì¼ ì¶”ê°€</button>
          <!-- âŒ 'íŒŒì¼ ì‚­ì œ' ë²„íŠ¼ ì œê±° -->
        </div>

        <button type="submit" class="btn btn-success w-100">ğŸ’¾ ì €ì¥</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>


<!-- ğŸ“œ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
function addFileField() {
  const div = document.getElementById("fileInputs");
  const input = document.createElement("input");
  input.type = "file";
  input.name = "files";
  input.multiple = true;
  input.className = "form-control mb-2";
  div.appendChild(input);
}

function removeFileField() {
  const div = document.getElementById("fileInputs");
  if (div.children.length > 1) div.removeChild(div.lastChild);
}

function addLinkField() {
  const div = document.getElementById("linkInputs");
  const input = document.createElement("input");
  input.type = "url";
  input.name = "link" + (div.children.length + 1);
  input.placeholder = "https://example.com";
  input.className = "form-control mb-2";
  div.appendChild(input);
}

function removeLinkField() {
  const div = document.getElementById("linkInputs");
  if (div.children.length > 1) div.removeChild(div.lastChild);
}

/* âœ… ê¸°ì¡´ íŒŒì¼ ì‚­ì œ ê¸°ëŠ¥ */
function removeExistingFile(idx, filename) {
  const container = document.getElementById(`currentFiles${idx}`);
  for (const child of container.children) {
    if (child.innerText.includes(filename)) {
      container.removeChild(child);
      break;
    }
  }
  const input = document.getElementById(`deleteFiles${idx}`);
  let current = input.value ? input.value.split(";") : [];
  if (!current.includes(filename)) {
    current.push(filename);
  }
  input.value = current.join(";");
}

/* âœ… ìˆ˜ì • ì‹œ ìƒˆ íŒŒì¼ ì¶”ê°€ (ì‚­ì œ ë²„íŠ¼ ì—†ìŒ) */
function addNewFileField() {
  const activeForm = document.querySelector('.collapse.show');
  if (activeForm) {
    const newInput = document.createElement('input');
    newInput.type = 'file';
    newInput.name = 'new_files';
    newInput.multiple = true;
    newInput.className = 'form-control mb-2';
    activeForm.querySelector('.mb-2:last-of-type').after(newInput);
  }
}
</script>
{% endblock %}


