{% extends "base.html" %}
{% block content %}
<div class="container mt-4">
  <h4>ğŸ“˜ ê°•ì˜ìë£Œ ì—…ë¡œë“œ</h4>
  <p>êµìˆ˜ë‹˜ì€ ê°•ì˜ìë£Œë¥¼ ì—…ë¡œë“œÂ·ìˆ˜ì •Â·ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

  <!-- ì—…ë¡œë“œ í¼ -->
  <form method="POST" enctype="multipart/form-data" class="mt-3" id="uploadForm">

    <!-- â‘  ë‚´ìš© -->
    <div class="mb-3">
      <label for="topic" class="form-label">â‘  ë‚´ìš©(Topic)</label>
      <input type="text" name="topic" id="topic" class="form-control"
             value="{{ edit_data['ë‚´ìš©(Topic)'] if edit_data else '' }}" required>
    </div>

    <!-- â‘¡ ìë£ŒíŒŒì¼ ì—…ë¡œë“œ -->
    <div class="mb-3">
      <label class="form-label">â‘¡ ìë£ŒíŒŒì¼ ì—…ë¡œë“œ (PDF, PPT, DOCX, HWP ë“±)</label>
      <div id="file_inputs"></div>
      <small class="text-muted">íŒŒì¼ì„ ì„ íƒí•˜ë©´ íŒŒì¼ëª…ì´ í‘œì‹œë˜ê³ , ì¶”ê°€Â·ì‚­ì œ ë²„íŠ¼ìœ¼ë¡œ ì¡°ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>

      {% if edit_data and edit_data["ìë£ŒíŒŒì¼(File URL)"] != "-" %}
      <div class="form-text mt-3">
        <b>ğŸ“‚ ê¸°ì¡´ íŒŒì¼:</b><br>
        {% for f in edit_data["ìë£ŒíŒŒì¼(File URL)"].split(";") if f.strip() %}
        <div class="d-flex align-items-center mb-1">
          <a href="{{ f.strip() }}" target="_blank" class="me-2">{{ f.strip().split('/')[-1] }}</a>
          <input type="checkbox" name="delete_existing_file" value="{{ f.strip() }}"> ì‚­ì œ
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- â‘¢ ì—°ê´€ ì‚¬ì´íŠ¸ -->
    <div class="mb-3">
      <label class="form-label">â‘¢ ì—°ê´€ ì‚¬ì´íŠ¸ (Google Drive, ë‰´ìŠ¤ ë“±)</label>
      <div id="site_inputs"></div>
      <small class="text-muted">ì‚¬ì´íŠ¸ ì£¼ì†Œ ì…ë ¥ í›„ Enter ë˜ëŠ” ì¶”ê°€ ë²„íŠ¼ìœ¼ë¡œ ìƒˆ ì¹¸ì„ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>

      {% if edit_data and edit_data["ì—°ê´€ì‚¬ì´íŠ¸(Related Site)"] != "-" %}
      <div class="form-text mt-3">
        <b>ğŸŒ ê¸°ì¡´ ì‚¬ì´íŠ¸:</b><br>
        {% for s in edit_data["ì—°ê´€ì‚¬ì´íŠ¸(Related Site)"].split(";") if s.strip() %}
        <div class="d-flex align-items-center mb-1">
          <a href="{{ s.strip() }}" target="_blank" class="me-2">{{ s.strip() }}</a>
          <input type="checkbox" name="delete_existing_site" value="{{ s.strip() }}"> ì‚­ì œ
        </div>
        {% endfor %}
      </div>
      {% endif %}
    </div>

    <!-- â‘£ ë¹„ê³  -->
    <div class="mb-3">
      <label for="notes" class="form-label">â‘£ ë¹„ê³ (Notes)</label>
      <input type="text" name="notes" id="notes" class="form-control"
             value="{{ edit_data['ë¹„ê³ (Notes)'] if edit_data else '' }}">
    </div>

    <!-- ë²„íŠ¼ -->
    {% if edit_data %}
      <input type="hidden" name="edit_index" value="{{ request.args.get('edit') }}">
      <button type="submit" class="btn btn-primary">âœï¸ ìˆ˜ì • ì™„ë£Œ</button>
      <a href="{{ url_for('upload_lecture') }}" class="btn btn-secondary ms-2">ì·¨ì†Œ</a>
    {% else %}
      <button type="submit" class="btn btn-success">ğŸ“¤ ìƒˆ ìë£Œ ì—…ë¡œë“œ</button>
    {% endif %}
  </form>

  <hr>

  <!-- ì—…ë¡œë“œëœ ëª©ë¡ -->
  <h5>ğŸ“‚ ì—…ë¡œë“œëœ ê°•ì˜ìë£Œ</h5>
  <table class="table table-bordered mt-3 text-center align-middle">
    <thead class="table-light">
      <tr>
        <th>ë²ˆí˜¸</th>
        <th>ë‚´ìš©</th>
        <th>ìë£ŒíŒŒì¼</th>
        <th>ì—°ê´€ì‚¬ì´íŠ¸</th>
        <th>ë¹„ê³ </th>
        <th>ì—…ë¡œë“œì‹œê°</th>
        <th>ìˆ˜ì •</th>
        <th>ì‚­ì œ</th>
      </tr>
    </thead>
    <tbody>
      {% if data %}
        {% for row in data %}
        <tr>
          <td>{{ loop.index }}</td>
          <td>{{ row["ë‚´ìš©(Topic)"] }}</td>
          <td>
            {% if row["ìë£ŒíŒŒì¼(File URL)"] != "-" %}
              {% for f in row["ìë£ŒíŒŒì¼(File URL)"].split(";") if f.strip() %}
                <a href="{{ f.strip() }}" target="_blank">ğŸ“ {{ f.strip().split('/')[-1] }}</a><br>
              {% endfor %}
            {% else %}-{% endif %}
          </td>
          <td>
            {% if row["ì—°ê´€ì‚¬ì´íŠ¸(Related Site)"] != "-" %}
              {% for s in row["ì—°ê´€ì‚¬ì´íŠ¸(Related Site)"].split(";") if s.strip() %}
                <a href="{{ s.strip() }}" target="_blank">ğŸŒ ì‚¬ì´íŠ¸ ì—´ê¸°</a><br>
              {% endfor %}
            {% else %}-{% endif %}
          </td>
          <td>{{ row["ë¹„ê³ (Notes)"] }}</td>
          <td>{{ row["ì—…ë¡œë“œì‹œê°"] }}</td>
          <td><a href="{{ url_for('upload_lecture') }}?edit={{ loop.index0 }}" class="btn btn-sm btn-primary">ìˆ˜ì •</a></td>
          <td>
            <form method="POST" style="display:inline;">
              <input type="hidden" name="delete_row" value="{{ loop.index0 }}">
              <button type="submit" class="btn btn-sm btn-danger">ì‚­ì œ</button>
            </form>
          </td>
        </tr>
        {% endfor %}
      {% else %}
        <tr><td colspan="8">ë“±ë¡ëœ ê°•ì˜ìë£Œê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>
      {% endif %}
    </tbody>
  </table>
</div>

<!-- âœ… JavaScript -->

<script>
// ğŸŒŸ ë¶€ë“œëŸ¬ìš´ ì „í™˜ íš¨ê³¼ìš© CSS ì‚½ì…
const style = document.createElement("style");
style.textContent = `
  .fade-in {
    opacity: 0;
    transform: translateY(-4px);
    transition: all 0.2s ease-in-out;
  }
  .fade-in.show {
    opacity: 1;
    transform: translateY(0);
  }
  .file-row:hover, .site-row:hover {
    background-color: #f9fafc;
    border-radius: 8px;
  }
  .file-name-label {
    font-weight: 500;
    color: #0d6efd;
  }
`;
document.head.appendChild(style);

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸ“ íŒŒì¼ ì—…ë¡œë“œ: ë¶€ë“œëŸ¬ìš´ ì¶”ê°€/ì‚­ì œ + íŒŒì¼ëª… í‘œì‹œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleFileSelect(input) {
  const parent = input.parentElement;
  const existingLabel = parent.querySelector(".file-name-label");
  if (existingLabel) existingLabel.remove();

  if (input.files.length > 0) {
    const file = input.files[0];
    const label = document.createElement("span");
    label.textContent = "ğŸ“ " + file.name;
    label.className = "file-name-label ms-2 me-2";
    input.after(label);

    // ìë™ìœ¼ë¡œ ë‹¤ìŒ ì¶”ê°€ ì¹¸ ìƒì„±
    const container = document.getElementById("file_inputs");
    const rows = container.querySelectorAll(".file-row");
    if (parent === rows[rows.length - 1]) {
      addNewFileInput(true);
    }
  }
}

function addNewFileInput(focus = false) {
  const container = document.getElementById("file_inputs");
  const div = document.createElement("div");
  div.className = "d-flex align-items-center mb-2 file-row fade-in";
  div.innerHTML = `
    <input type="file" name="file_upload"
           accept=".pdf,.ppt,.pptx,.docx,.hwp"
           class="form-control me-2 file-input"
           onchange="handleFileSelect(this)">
    <button type="button" class="btn btn-outline-primary btn-sm me-1"
            onclick="addNewFileInput(true)">ï¼‹ ì¶”ê°€</button>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="removeFileInput(this)">ğŸ—‘ ì‚­ì œ</button>
  `;
  container.appendChild(div);
  setTimeout(() => div.classList.add("show"), 10);
  if (focus) div.querySelector("input").focus();
}

function removeFileInput(btn) {
  const div = btn.parentElement;
  div.classList.remove("show");
  setTimeout(() => {
    div.remove();
    ensureAtLeastOneFileInput();
  }, 180);
}

function ensureAtLeastOneFileInput() {
  const container = document.getElementById("file_inputs");
  if (container.children.length === 0) addNewFileInput();
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸŒ ì‚¬ì´íŠ¸ ì…ë ¥: ìë™ ì¶”ê°€ + í¬ì»¤ìŠ¤ ì´ë™ + ë¶€ë“œëŸ¬ìš´ ì‚­ì œ
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleSiteInput(input) {
  if (input.value.trim() !== "") {
    const container = document.getElementById("site_inputs");
    const allInputs = container.querySelectorAll(".site-input");
    const lastInput = allInputs[allInputs.length - 1];
    if (input === lastInput) {
      addNewSiteInput(true);
    }
  }
}

function addNewSiteInput(focus = false) {
  const container = document.getElementById("site_inputs");
  const div = document.createElement("div");
  div.className = "d-flex align-items-center mb-2 site-row fade-in";
  div.innerHTML = `
    <input type="url" name="related_site"
           placeholder="https://example.com"
           class="form-control me-2 site-input"
           onchange="handleSiteInput(this)"
           onkeydown="handleSiteEnter(event, this)">
    <button type="button" class="btn btn-outline-primary btn-sm me-1"
            onclick="addNewSiteInput(true)">ï¼‹ ì¶”ê°€</button>
    <button type="button" class="btn btn-outline-danger btn-sm"
            onclick="removeSiteInput(this)">ğŸ—‘ ì‚­ì œ</button>
  `;
  container.appendChild(div);
  setTimeout(() => div.classList.add("show"), 10);
  if (focus) div.querySelector("input").focus();
}

// ğŸ”¸ ìƒˆë¡œ ì¶”ê°€ë˜ëŠ” í•¨ìˆ˜: Enter í‚¤ë¥¼ ëˆŒë €ì„ ë•Œ submit ë°©ì§€ + ë‹¤ìŒ ì¹¸ ì¶”ê°€
function handleSiteEnter(event, input) {
  if (event.key === "Enter") {
    event.preventDefault();  // âœ… ê¸°ë³¸ submit ì°¨ë‹¨
    handleSiteInput(input);  // âœ… ë‹¤ìŒ ì…ë ¥ì¹¸ ì¶”ê°€
    // ë‹¤ìŒ ì¹¸ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
    const container = document.getElementById("site_inputs");
    const allInputs = container.querySelectorAll(".site-input");
    const lastInput = allInputs[allInputs.length - 1];
    lastInput.focus();
  }
}


function removeSiteInput(btn) {
  const div = btn.parentElement;
  div.classList.remove("show");
  setTimeout(() => {
    div.remove();
    ensureAtLeastOneSiteInput();
  }, 180);
}

function ensureAtLeastOneSiteInput() {
  const container = document.getElementById("site_inputs");
  if (container.children.length === 0) addNewSiteInput();
}


// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ğŸŒ ì´ˆê¸° ì„¸íŒ…
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener("DOMContentLoaded", () => {
  ensureAtLeastOneFileInput();
  ensureAtLeastOneSiteInput();
});
</script>





{% endblock %}
